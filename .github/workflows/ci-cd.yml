name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # 合约测试和部署
  contracts:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: contracts/package-lock.json
    
    - name: Install Dependencies
      working-directory: ./contracts
      run: npm ci
    
    - name: Run Tests
      working-directory: ./contracts
      run: npm test
    
    - name: Compile Contracts
      working-directory: ./contracts
      run: npx hardhat compile
    
    # 只有在main分支且手动触发时才部署
    - name: Deploy to Sepolia
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      working-directory: ./contracts
      run: |
        echo "${{ secrets.SEPOLIA_RPC_URL }}" > .env
        echo "PRIVATE_KEY=${{ secrets.DEPLOYER_PRIVATE_KEY }}" >> .env
        echo "ETHERSCAN_API_KEY=${{ secrets.ETHERSCAN_API_KEY }}" >> .env
        npx hardhat run scripts/deploy.js --network sepolia
      env:
        SEPOLIA_RPC_URL: ${{ secrets.SEPOLIA_RPC_URL }}

  # 后端测试和部署
  backend:
    runs-on: ubuntu-latest
    needs: contracts
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
    
    - name: Install Dependencies
      working-directory: ./backend
      run: npm ci
    
    - name: Run Prisma Generate
      working-directory: ./backend
      run: npx prisma generate
    
    - name: Run Tests
      working-directory: ./backend
      run: |
        npm test
      env:
        DATABASE_URL: postgresql://postgres:password@localhost:5432/test_db
    
    - name: Build Backend
      working-directory: ./backend
      run: npm run build

  # 前端测试和部署
  frontend:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install Dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Run Tests
      working-directory: ./frontend
      run: npm test
    
    - name: Build Frontend
      working-directory: ./frontend
      run: npm run build
    
    - name: Deploy to Vercel
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: amondnet/vercel-action@v20
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        working-directory: ./frontend